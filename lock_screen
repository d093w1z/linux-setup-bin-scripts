#!/usr/bin/env bash
#
# lock_screen.sh - Generic lock screen script using i3lock-color
#
# Features:
#   - Screenshot of all monitors
#   - Blur + darken effect
#   - Overlay image (only on primary monitor)
#   - Minimalist i3lock-color theme
#
# Dependencies: scrot, imagemagick (convert), xrandr, i3lock-color

set -euox pipefail

# === Configurable Settings ===
OVERLAY_IMAGE="$HOME/bin/rick-morty.png"   # path to overlay image
OVERLAY_OFFSET_X=1000                       # offset from left edge of primary monitor
OVERLAY_OFFSET_Y=500                       # offset from bottom of primary monitor
BLUR_STRENGTH="0x8"                        # ImageMagick blur strength
DARKEN_PERCENT=40                          # how much to darken (0-100)
FONT="JetBrainsMono Nerd Font"             # font used by i3lock-color

OVERLAY_IMAGE="${OVERLAY_IMAGE:-}"

# === Temp files ===
SHOT=$(mktemp --suffix=.png /tmp/screen_locked.XXXXXX)
BLUR=$(mktemp --suffix=.png /tmp/screen_blur.XXXXXX)
FINAL=$(mktemp --suffix=.png /tmp/screen_final.XXXXXX)

cleanup() {
    rm -f "$SHOT" "$BLUR" "$FINAL"
    xset dpms 0 0 0
}
trap cleanup HUP INT TERM EXIT

# === Take screenshot ===
if ! scrot -o "$SHOT"; then
    echo "scrot failed, using fallback background"
    convert -size 1920x1080 xc:black "$SHOT"
fi

# === Blur & darken ===
convert "$SHOT" -blur "$BLUR_STRENGTH" -fill black -colorize "$DARKEN_PERCENT%" "$BLUR"

# === Detect primary monitor geometry ===
PRIMARY=""
PRIMARY=$(xrandr --query | awk '/ primary/{print $4; exit}') || true
if [ -z "$PRIMARY" ]; then
    # fallback: use first connected monitor
    PRIMARY=$(xrandr --query | awk '/ connected/{print $3; exit}') || true
fi

if [ -n "$PRIMARY" ]; then
    # Split geometry string WxH+X+Y safely
    PW=$(echo "$PRIMARY" | cut -d'x' -f1)
    PH=$(echo "$PRIMARY" | cut -d'x' -f2 | cut -d'+' -f1)
    PX=$(echo "$PRIMARY" | cut -d'+' -f2)
    PY=$(echo "$PRIMARY" | cut -d'+' -f3)

    # Overlay image only on primary monitor
    if [[ -f "$OVERLAY_IMAGE" ]]; then
        convert "$BLUR" "$OVERLAY_IMAGE" \
            -geometry +$((PX+OVERLAY_OFFSET_X))+$((PY+PH-OVERLAY_OFFSET_Y)) \
            -composite "$FINAL"
    else
        echo "Overlay image not found: $OVERLAY_IMAGE"
        cp "$BLUR" "$FINAL"
    fi
else
    echo "No monitor geometry detected; skipping overlay"
    cp "$BLUR" "$FINAL"
fi

# === Lock screen ===
i3lock \
    -i "$FINAL" \
    --inside-color=00000000 \
    --ring-color=ffffff88 \
    --line-uses-inside \
    --keyhl-color=33ccffaa \
    --bshl-color=ff3355aa \
    --separator-color=00000000 \
    --insidever-color=00000000 \
    --ringver-color=33ccffaa \
    --insidewrong-color=00000000 \
    --ringwrong-color=ff3355aa \
    --verif-text="..." \
    --wrong-text="X" \
    --noinput-text=" " \
    --time-color=ffffffff \
    --time-font="$FONT" \
    --time-size=48 \
    --date-color=ffffffff \
    --date-font="$FONT" \
    --date-size=20 \
    --time-str="%H:%M" \
    --date-str="%A, %d %B" \
    --greeter-text="Locked" \
    --greeter-font="$FONT" \
    --greeter-size=24 \
    --greeter-color=ffffffcc \
    --clock \
    --indicator \
    --radius 120 \
    --ring-width 10
set +x