#!/usr/bin/env bash
# bspwm external rules with reliable debug logging + improved PiP and dialog detection

LOG_FILE="$HOME/bin/logs/bspwm-external-rules.log"
DEBUG_LOG="$HOME/bin/logs/bspwm-external-rules.debug.log"

mkdir -p "$(dirname "$LOG_FILE")"

# ---------------- LOGGING ----------------------

log_info() {
    printf '%s [INFO] %s\n' "$(date '+%F %T')" "$*" >> "$LOG_FILE"
}

log_debug() {
    printf '%s [DEBUG] %s\n' "$(date '+%F %T')" "$*" >> "$DEBUG_LOG"
    [[ "$BSPWM_RULES_VERBOSE" = "1" ]] && printf '%s [DEBUG] %s\n' "$(date '+%F %T')" "$*" >> "$LOG_FILE"
}

log_error() {
    printf '%s [ERROR] %s\n' "$(date '+%F %T')" "$*" | tee -a "$LOG_FILE" >> "$DEBUG_LOG"
}

emit() {
    # stdout for bspwm
    printf '%s\n' "$*"
    # logged with context
    log_info "emit: $*  (wid=$wid class=$class instance=$instance title=$window_title role=$window_role types=$window_types)"
}

# ---------------- WINDOW PROPERTIES ----------------------

normalize_names() {
    class="${class,,}"
    instance="${instance,,}"
}

get_window_role() {
    window_role="$(xprop -id "$wid" WM_WINDOW_ROLE 2>/dev/null \
        | sed -nE 's/.*"(.*)".*/\1/p' | tr '[:upper:]' '[:lower:]')"
}

get_window_title() {
    window_title="$(xprop -id "$wid" WM_NAME 2>/dev/null \
        | sed -nE 's/.*"(.*)".*/\1/p')"
    window_title="${window_title,,}"

    [[ -z "$window_title" ]] && {
        window_title="$(xprop -id "$wid" _NET_WM_NAME 2>/dev/null \
            | sed -nE 's/.*"(.*)".*/\1/p')"
        window_title="${window_title,,}"
    }
}

get_window_type() {
    window_types="$(xprop -id "$wid" _NET_WM_WINDOW_TYPE 2>/dev/null \
        | grep -oE '_NET_WM_WINDOW_TYPE_[^ ,]+' | tr '[:upper:]' '[:lower:]')"
}

is_transient() {
    local parent
    parent="$(xprop -id "$wid" WM_TRANSIENT_FOR 2>/dev/null | grep -o '0x.*')"
    [[ -n "$parent" && "$parent" != "0x0" ]]
}

# ---------------- IMPROVED MATCHERS ----------------------

is_dialog_like() {
    # reliable GTK/Qt/Electron dialog detection
    grep -q '_net_wm_window_type_dialog' <<< "$window_types" && return 0
    grep -q '_net_wm_window_type_modal_dialog' <<< "$window_types" && return 0
    grep -q '_net_wm_window_type_utility' <<< "$window_types" && return 0
    is_transient && return 0

    # modal state (rare but used by Firefox)
    xprop -id "$wid" _NET_WM_STATE 2>/dev/null \
        | grep -qi '_NET_WM_STATE_MODAL' && return 0

    return 1
}

is_picture_in_picture() {
    # Firefox PiP variations
    [[ "$window_role" == "pictureinpicture" ]] && return 0
    [[ "$window_title" == "picture-in-picture" ]] && return 0
    [[ "$window_title" == *"pip"* ]] && return 0

    # Chromium/Firefox utility type
    grep -q '_net_wm_window_type_utility' <<< "$window_types" || return 1

    # Sometimes PiP are small windows (<500px wide)
    # Avoid calling xwininfo for every window
    if size=$(xwininfo -id "$wid" 2>/dev/null | grep 'Width' | awk '{print $2}'); then
        [[ "$size" -lt 500 ]] && return 0
    fi

    return 1
}

match_auto_floating() {
    if is_dialog_like; then
        log_debug "Dialog detected -> float (wid=$wid)"
        emit "state=floating"
        return 0
    fi

    return 1
}

match_floating() {
    if is_picture_in_picture; then
        log_debug "PiP detected (wid=$wid)"
        emit "state=floating sticky=on border=off rectangle=400x225+1520+830"
        return 0
    fi

    case "$class:$instance" in
        gimp:*) emit "state=floating desktop=^8 follow=on"; return 0 ;;
        mplayer2:*) emit "state=floating"; return 0 ;;
        feh:*) emit "state=floating"; return 0 ;;
        gnome-calculator:*) emit "state=floating"; return 0 ;;
        pavucontrol:*) emit "state=floating"; return 0 ;;
        mpv:*) emit "state=floating"; return 0 ;;
        blueman-manager:*) emit "state=floating"; return 0 ;;
        thunderbird-default:msgcompose) emit "state=floating sticky=on"; return 0 ;;
        focotimer:*) emit "state=floating border=off focus=off rectangle=300x300+1520+450"; return 0 ;;
        atcos:*) emit "state=floating follow=on"; return 0 ;;
    esac
    return 1
}

match_other() {
    case "$class:$instance" in
        kupfer.py:*) emit "focus=on"; return 0 ;;
        screenkey:*) emit "manage=off"; return 0 ;;
    esac
    return 1
}

match_desktop() {
    case "$class" in
        firefox|firefox-esr|google-chrome|chromium) emit "desktop=^2 follow=off"; return 0 ;;
        alacritty|xterm) emit "desktop=^1"; return 0 ;;
        code) emit "desktop=^3"; return 0 ;;
    esac
    return 1
}

# ---------------- MAIN ----------------------

wid="$1"
class="$2"
instance="$3"

get_window_role
get_window_title
get_window_type
normalize_names

log_debug "NEW WINDOW wid=$wid class=$class instance=$instance role=$window_role title=$window_title types=$window_types"

match_auto_floating
match_floating && exit 0
match_other && exit 0
match_desktop && exit 0

exit 0

